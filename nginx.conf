load_module modules/ngx_http_image_filter_module.so;

events {}

http {

    upstream api-server {
        server docker.for.mac.localhost:8001 ;
        server 127.0.0.1:8001 ;
        server 127.0.0.1:8002 ;
        server docker.for.mac.localhost:8000 backup;
        server 127.0.0.1:8000 backup;
    }

    server {
        listen 80;

        access_log /var/log/nginx/web_io_access.log;
        error_log  /var/log/nginx/web_io_error.log;

        root /usr/share/nginx/html;

        location / {
            try_files $uri $uri/ =404;
        }

        # The new section you can copy/paste in
        location ~ "^/media/(?<width>\d+)/(?<image>.+)$" {
            alias /usr/share/nginx/html/images/$image;
            image_filter resize $width -;
            image_filter_jpeg_quality 75;
            image_filter_buffer 8M;
        }

        location /api {
            proxy_pass http://springbootapp/;
        }

    }
}